{"ts":1365942928180,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var fs = require('fs')\n\nvar walk = function(dir, action, done) {\n\n// this flag will indicate if an error occured (in this case we don't want to go on walking the tree)\nvar dead = false;\n\n// this flag will store the number of pending async operations\nvar pending = 0;\n\nvar fail = function(err) {\n    if(!dead&& done) {\n        dead = true;\n        done(err);\n    }\n};\n\nvar checkSuccess = function() {\n    if(!dead && pending == 0 && done) {\n        done();\n    }\n};\n\nvar performAction = function(file, stat) {\n    if(!dead) {\n        try {\n            action(file, stat);\n        }\n        catch(error) {\n            fail(error);\n        }\n    }\n};\n\n// this function will recursively explore one directory in the context defined by the variables above\nvar dive = function(dir) {\n    pending++; // async operation starting after this line\n    fs.readdir(dir, function(err, list) {\n        if(!dead) { // if we are already dead, we don't do anything\n            if (err) {\n                fail(err); // if an error occured, let's fail\n            }\n            else { // iterate over the files\n                list.forEach(function(file) {\n                    if(!dead) { // if we are already dead, we don't do anything\n                        var path = dir + \"/\" + file;\n                        pending++; // async operation starting after this line\n                        fs.stat(path, function(err, stat) {\n                            if(!dead) { // if we are already dead, we don't do anything\n                                if (err) {\n                                    fail(err); // if an error occured, let's fail\n                                }\n                                else {\n                                    if (stat && stat.isDirectory()) {\n                                        dive(path); // it's a directory, let's explore recursively\n                                    }\n                                    else {\n                                        performAction(path, stat); // it's not a directory, just perform the action\n                                    }\n                                    pending--; checkSuccess(); // async operation complete\n                                }\n                            }\n                        });\n                    }\n                });\n                pending--; checkSuccess(); // async operation complete\n            }\n        }\n    });\n};\n\n// start exploration\ndive(dir);\n};\n\nvar addToWatchList = function(filename, handleChange){\nfs.watch(filename, function(event, filename){\n    debounceChange(event, filename, handleChange)\n})\n}\n\nvar isAllowed = function(filename, issallowed){\nvar boole = false\nissallowed.forEach(function(checkString){\n    if(filename.indexOf(checkString) != -1){\n        boole = true\n    }\n})\nreturn boole\n}\n\nvar t1 = null;\nvar debounceChange = function(event, filename, handleChange){\nvar seconds = 0;\nif(t1){\n    var t2 = new Date()\n    var dif = t1.getTime() - t2.getTime()\n    var Seconds_from_T1_to_T2 = dif / 1000;\n    seconds = Math.abs(Seconds_from_T1_to_T2);\n    if(seconds < 1){\n        handleChange(event, filename)\n    }\n}\nt1 = new Date()\n}\n\nvar startwalk = function(handleChange){\nfs.readFile(__dirname+'/.lorentzwatch', 'utf-8',  function(err, data){\n    var issallowed;\n    if (err || !data) issallowed = ['public/', 'app.js']\n\n    else issallowed = data.split(\"\\n\")\n\n    issallowed.forEach(function(d, i){\n        if(d === '')\n            delete issallowed[i]\n    })\n\n    walk(__dirname, function(filename){\n        if(isAllowed(filename, issallowed))  addToWatchList(filename, handleChange)\n    })\n})\n\n}\n\nvar liveReload = function(port){\nvar app = require('http').createServer(handler)\n  , io = require('socket.io').listen(app)\n  , fs = require('fs')\n\napp.listen(port || 8081);\n\nfunction handler (req, res) {}\n\nio.sockets.on('connection', function (socket) {\n    startwalk(function(e, f){\n        socket.emit('refresh', function () {});\n    })\n});\n\n}\n\n// exports.walk = startwalk;\nexports.liveReload = liveReload\n\nvar runningAsScript = !module.parent;\nif(runningAsScript){\n    var port = process.argv[2] || 8081\n    liveReload(port)\n}\n\n"]],"start1":0,"start2":0,"length1":0,"length2":4167}]],"length":4167}
{"contributors":[],"silentsave":false,"ts":1365952578543,"patch":[[{"diffs":[[0,"one) {\n\n"],[1,"    "],[0,"// this "]],"start1":58,"start2":58,"length1":16,"length2":20},{"diffs":[[0,"e tree)\n"],[1,"    "],[0,"var dead"]],"start1":164,"start2":164,"length1":16,"length2":20},{"diffs":[[0,"false;\n\n"],[1,"    "],[0,"// this "]],"start1":187,"start2":187,"length1":16,"length2":20},{"diffs":[[0,"rations\n"],[1,"    "],[0,"var pend"]],"start1":254,"start2":254,"length1":16,"length2":20},{"diffs":[[0,"g = 0;\n\n"],[1,"    "],[0,"var fail"]],"start1":276,"start2":276,"length1":16,"length2":20},{"diffs":[[0,"tion(err) {\n"],[1,"    "],[0,"    if(!dead"]],"start1":303,"start2":303,"length1":24,"length2":28},{"diffs":[[0,"        "],[1,"    "],[0,"dead = t"]],"start1":342,"start2":342,"length1":16,"length2":20},{"diffs":[[0,"= true;\n"],[1,"    "],[0,"        "]],"start1":359,"start2":359,"length1":16,"length2":20},{"diffs":[[0,"e(err);\n    "],[-1,"}\n};\n\n"],[1,"    }\n    };\n\n    "],[0,"var checkSuc"]],"start1":382,"start2":382,"length1":30,"length2":42},{"diffs":[[0,"unction() {\n"],[1,"    "],[0,"    if(!dead"]],"start1":432,"start2":432,"length1":24,"length2":28},{"diffs":[[0,"    "],[1,"    "],[0,"done();\n"],[1,"    "],[0,"    }\n"],[-1,"};\n\n"],[1,"    };\n\n    "],[0,"var "]],"start1":492,"start2":492,"length1":26,"length2":42},{"diffs":[[0,"le, stat) {\n"],[1,"    "],[0,"    if(!dead"]],"start1":561,"start2":561,"length1":24,"length2":28},{"diffs":[[0,"    "],[1,"   "],[1," "],[0,"try {\n"],[1,"    "],[0,"    "]],"start1":597,"start2":597,"length1":14,"length2":22},{"diffs":[[0," stat);\n        "],[1,"   "],[1," "],[0,"}\n"],[1,"    "],[0,"        catch(er"]],"start1":639,"start2":639,"length1":34,"length2":42},{"diffs":[[0,") {\n            "],[1,"   "],[1," "],[0,"fail(error);\n   "]],"start1":684,"start2":684,"length1":32,"length2":36},{"diffs":[[0,"    "],[-1,"}\n"],[1,"    }\n   "],[0,"    "],[1," "],[0,"}\n"],[-1,"};\n\n"],[1,"    };\n\n    "],[0,"// t"]],"start1":721,"start2":721,"length1":20,"length2":36},{"diffs":[[0,"s above\n"],[1,"    "],[0,"var dive"]],"start1":847,"start2":847,"length1":16,"length2":20},{"diffs":[[0,"(dir) {\n    "],[1,"   "],[1," "],[0,"pending++; /"]],"start1":878,"start2":878,"length1":24,"length2":28},{"diffs":[[0,"r this line\n"],[1,"    "],[0,"    fs.readd"]],"start1":937,"start2":937,"length1":24,"length2":28},{"diffs":[[0,"list) {\n        "],[1,"   "],[1," "],[0,"if(!dead) { // i"]],"start1":987,"start2":987,"length1":32,"length2":36},{"diffs":[[0,"ing\n            "],[1,"    "],[0,"if (err) {\n     "]],"start1":1063,"start2":1063,"length1":32,"length2":36},{"diffs":[[0,"                "],[1,"  "],[1,"  "],[0,"fail(err); // if"]],"start1":1094,"start2":1094,"length1":32,"length2":36},{"diffs":[[0,"ail\n            "],[-1,"}\n"],[1,"    }\n  "],[0,"            else"]],"start1":1156,"start2":1156,"length1":34,"length2":40},{"diffs":[[0,"            "],[1,"  "],[0,"else { // it"]],"start1":1180,"start2":1180,"length1":24,"length2":26},{"diffs":[[0,"        "],[1,"    "],[0,"list.for"]],"start1":1235,"start2":1235,"length1":16,"length2":20},{"diffs":[[0,"                "],[1,"  "],[1,"  "],[0,"if(!dead) { // i"]],"start1":1281,"start2":1281,"length1":32,"length2":36},{"diffs":[[0,"            "],[1,"    "],[0,"var path = d"]],"start1":1373,"start2":1373,"length1":24,"length2":28},{"diffs":[[0,"                "],[1,"  "],[1,"  "],[0,"pending++; // as"]],"start1":1426,"start2":1426,"length1":32,"length2":36},{"diffs":[[0,"        "],[1,"    "],[0,"fs.stat("]],"start1":1517,"start2":1517,"length1":16,"length2":20},{"diffs":[[0,"                "],[1,"  "],[1,"  "],[0,"if(!dead) { // i"]],"start1":1577,"start2":1577,"length1":32,"length2":36},{"diffs":[[0,"                "],[1,"    "],[0,"if (err) {\n     "]],"start1":1673,"start2":1673,"length1":32,"length2":36},{"diffs":[[0,"                "],[1,"  "],[1,"  "],[0,"fail(err); // if"]],"start1":1724,"start2":1724,"length1":32,"length2":36},{"diffs":[[0,"                "],[-1,"}\n"],[1,"    }\n  "],[0,"                "]],"start1":1806,"start2":1806,"length1":34,"length2":40},{"diffs":[[0,"                "],[1,"  "],[0,"else {\n"],[1,"    "],[0,"                "]],"start1":1846,"start2":1846,"length1":39,"length2":45},{"diffs":[[0,"ectory()) {\n"],[1,"    "],[0,"            "]],"start1":1933,"start2":1933,"length1":24,"length2":28},{"diffs":[[0,"                "],[1,"    "],[0,"}\n              "]],"start1":2068,"start2":2068,"length1":32,"length2":36},{"diffs":[[0,"                "],[1," "],[1,"   "],[0,"else {\n"],[1,"    "],[0,"                "]],"start1":2110,"start2":2110,"length1":39,"length2":47},{"diffs":[[0,"                "],[-1,"}\n"],[1,"    }\n    "],[0,"                "]],"start1":2277,"start2":2277,"length1":34,"length2":42},{"diffs":[[0,"                "],[1," "],[-1,"}\n"],[1,"   }\n    "],[0,"                "]],"start1":2410,"start2":2410,"length1":34,"length2":42},{"diffs":[[0,"                "],[1,"    "],[0,"});\n            "]],"start1":2474,"start2":2474,"length1":32,"length2":36},{"diffs":[[0,"                "],[1,"    "],[0,"}\n              "]],"start1":2502,"start2":2502,"length1":32,"length2":36},{"diffs":[[0,"                "],[1," "],[1,"   "],[0,"});\n"],[1,"    "],[0,"                "]],"start1":2524,"start2":2524,"length1":36,"length2":44},{"diffs":[[0,"    "],[-1,"}\n        }\n    });\n};\n\n"],[1,"    }\n            }\n        });\n    };\n\n    "],[0,"// s"]],"start1":2631,"start2":2631,"length1":32,"length2":52},{"diffs":[[0,"oration\n"],[1,"    "],[0,"dive(dir"]],"start1":2692,"start2":2692,"length1":16,"length2":20},{"diffs":[[0,"unction("],[1,"dir, "],[0,"handleCh"]],"start1":3437,"start2":3437,"length1":16,"length2":21},{"diffs":[[0,"eadFile("],[-1,"__"],[0,"dir"],[-1,"name"],[0,"+'/.lore"]],"start1":3469,"start2":3469,"length1":25,"length2":19},{"diffs":[[0,"alk("],[-1,"__"],[0,"dir"],[-1,"name"],[0,", fu"]],"start1":3754,"start2":3754,"length1":17,"length2":11},{"diffs":[[0,"ion("],[1,"dir, "],[0,"port){\n"],[1,"    "],[0,"var "]],"start1":3903,"start2":3903,"length1":15,"length2":24},{"diffs":[[0,"andler)\n"],[1,"    "],[0,"  , io ="]],"start1":3963,"start2":3963,"length1":16,"length2":20},{"diffs":[[0,"en(app)\n"],[1,"    "],[0,"  , fs ="]],"start1":4009,"start2":4009,"length1":16,"length2":20},{"diffs":[[0,"e('fs')\n"],[-1,"\n"],[1,"      , url = require(\"url\")\n\n    "],[0,"app.list"]],"start1":4036,"start2":4036,"length1":17,"length2":50},{"diffs":[[0,"8081);\n\n"],[1,"\n\n    "],[0,"function"]],"start1":4097,"start2":4097,"length1":16,"length2":22},{"diffs":[[0,"s) {"],[-1,"}\n\nio.sockets.on('connection', function (socket) {\n"],[1,"\n        var uri = url.parse(req.url).pathname;\n        if(uri.split('/').slice(-1)[0] === 'lorentz.js' ){\n            res.writeHeader(200, {\"Content-Type\": \"text/javascript\"});\n            res.write(script);\n            res.end();\n        }\n    }\n\n    io.sockets.on('connection', function (socket) {\n        socket.emit('confirm', 'Connection is confirmed.');\n    "],[0,"    "]],"start1":4136,"start2":4136,"length1":59,"length2":373},{"diffs":[[0,"artwalk("],[1,"dir, "],[0,"function"]],"start1":4511,"start2":4511,"length1":16,"length2":21},{"diffs":[[0,"(e, f){\n        "],[1,"  "],[1,"  "],[0,"socket.emit('ref"]],"start1":4532,"start2":4532,"length1":32,"length2":36},{"diffs":[[0,"    "],[-1,"})\n});\n\n}\n\n// exports.walk = startwalk;"],[1,"    })\n    });\n\n}\n"],[0,"\nexp"]],"start1":4592,"start2":4592,"length1":47,"length2":26},{"diffs":[[0,"ad(port)\n}\n\n"],[1,"var script =\n    'var head= document.getElementsByTagName(\"head\")[0];\\n'+\n    'var script= document.createElement(\"script\");\\n'+\n    'script.type= \"text/javascript\";\\n'+\n    'script.src= \"http://localhost:8081/socket.io/socket.io.js\";\\n'+\n    'head.appendChild(script);\\n'+\n    'window.addEventListener(\"load\", function (e)  {\\n'+\n    'var socket = io.connect(\"http://localhost:8081\");\\n'+\n    'socket.on(\"confirm\", function(data){\\n'+\n    'console.log(data)\\n'+\n    '})\\n'+\n    'socket.on(\"refresh\", function (filename) {\\n'+\n    'location.reload(true);\\n'+\n    '});\\n'+\n    '}, false);'"]],"start1":4758,"start2":4758,"length1":12,"length2":600}]],"length":5358,"saved":false}
